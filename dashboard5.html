<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Incidentes C4 — Seguro CSP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { margin:0; font-family:system-ui; background:#0f172a; color:#e5e7eb; }
header { padding:16px; display:flex; flex-wrap:wrap; align-items:center; gap:12px; border-bottom:1px solid #1f2937; }
.file-input, .btn { padding:8px 12px; border-radius:8px; cursor:pointer; }
.file-input { background:#111827; color:#e5e7eb; }
.btn { background:#22d3ee; border:none; font-weight:700; }
.grid { display:grid; grid-template-columns:repeat(12,1fr); gap:16px; padding:16px; }
.card { background:#111827; border-radius:16px; padding:12px; box-shadow:0 8px 20px rgba(0,0,0,.25); min-height:300px; }
.col-6 { grid-column:span 6; } .col-12 { grid-column:span 12; }
.chart, .map { width:100%; height:360px; }
table { width:100%; border-collapse:collapse; font-size:13px; }
th, td { border-bottom:1px solid #1f2937; padding:6px 8px; text-align:left; }
th { position:sticky; top:0; background:#111827; color:#94a3b8; }
.table-wrap { max-height:360px; overflow:auto; border-radius:12px; border:1px solid #1f2937; }
</style>
</head>
<body>
<header>
<h1>Dashboard Incidentes C4 con D3.js</h1>
<input class="file-input" type="file" id="inputCSV" accept=".csv" />
<button id="sampleBtn" class="btn">Cargar CSV</button>
<label style="color:#94a3b8; margin-left:12px;">Máx filas tabla: <input type="number" id="maxRows" value="100" min="1" max="100" style="width:60px"/></label>
</header>
<section class="grid">
<div class="card col-6"><h3>Incidentes por Tipo</h3><svg id="chart-tipo" class="chart"></svg></div>
<div class="card col-6"><h3>Incidentes por Alcaldía</h3><svg id="chart-alcaldia" class="chart"></svg></div>
<div class="card col-12"><h3>Incidentes por Día</h3><svg id="chart-dia" class="chart"></svg></div>
<div class="card col-12"><h3>Mapa Leaflet Interactivo</h3><div id="map-leaflet" class="map"></div></div>
<div class="card col-12"><h3>Tabla de Incidentes</h3><div class="table-wrap"><table id="tablaDatos"><thead></thead><tbody></tbody></table></div></div>
</section>
<script>
// ===== Parser CSV seguro =====
function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  const headers=lines[0].split(',').map(h=>h.trim());
  const data=lines.slice(1).map(line=>{
    const values=line.split(',');
    const obj={};
    headers.forEach((h,i)=>{ obj[h]=values[i]?.trim()||''; });
    return obj;
  });
  return data;
}

// ===== Normalización =====
function normalizeRaw(raw){
  return raw.map(d=>({
    fecha_creacion: d.fecha_creacion||'',
    tipo_incidente_c4: d.tipo_incidente_c4||'Sin dato',
    alcaldia_catalogo: d.alcaldia_catalogo||'Sin dato',
    latitud: parseFloat(d.latitud)||null,
    longitud: parseFloat(d.longitud)||null,
    dia_semana_numero: parseInt(d.dia_semana_numero)||null
  })).filter(d=>d.tipo_incidente_c4||d.alcaldia_catalogo||(d.latitud&&d.longitud));
}

// ===== Paleta de colores =====
const colorScale = d3.scaleOrdinal()
  .range([
    "#22d3ee","#f87171","#34d399","#fbbf24","#a78bfa",
    "#60a5fa","#fb923c","#2dd4bf","#f472b6","#c084fc"
  ]);

// ===== Tabla =====
function renderTabla(data){
  const maxRows=parseInt(document.getElementById('maxRows').value)||100;
  if(!data.length) return;
  const tbody=d3.select('#tablaDatos tbody'); tbody.html('');
  const columns=Object.keys(data[0]);
  const thead=d3.select('#tablaDatos thead');
  if(!thead.select('tr').node()) thead.append('tr').selectAll('th').data(columns).enter().append('th').text(d=>d);
  const rows=tbody.selectAll('tr').data(data.slice(0,maxRows)).enter().append('tr');
  rows.selectAll('td').data(r=>columns.map(c=>r[c]||'')).enter().append('td').text(d=>d);
}

// ===== Gráficos =====
function drawBar({svg,data,xAccessor,yAccessor,rotateX}){
  svg.selectAll('*').remove(); if(!data.length) return;
  const width=svg.node().clientWidth||600;
  const height=svg.node().clientHeight||360;
  const margin={top:20,right:20,bottom:rotateX?70:40,left:50};
  const innerW=width-margin.left-margin.right;
  const innerH=height-margin.top-margin.bottom;
  const g=svg.append('g').attr('transform',`translate(${margin.left},${margin.top})`);
  const x=d3.scaleBand().domain(data.map(xAccessor)).range([0,innerW]).padding(0.2);
  const y=d3.scaleLinear().domain([0,d3.max(data,yAccessor)||1]).range([innerH,0]);
  g.selectAll('rect').data(data).enter().append('rect')
    .attr('x',d=>x(xAccessor(d))).attr('y',d=>y(yAccessor(d)))
    .attr('width',x.bandwidth()).attr('height',d=>innerH-y(yAccessor(d)))
    .attr('fill',d=>colorScale(xAccessor(d)));
  g.append('g').attr('transform',`translate(0,${innerH})`).call(d3.axisBottom(x)).selectAll('text')
    .attr('transform',rotateX?'rotate(-35)':'').style('text-anchor',rotateX?'end':'middle');
  g.append('g').call(d3.axisLeft(y).ticks(6));
}

function renderCharts(data){
  const tipoData=Array.from(d3.rollup(data,v=>v.length,d=>d.tipo_incidente_c4),([tipo,total])=>({tipo,total})).sort((a,b)=>b.total-a.total).slice(0,20);
  drawBar({svg:d3.select('#chart-tipo'),data:tipoData,xAccessor:d=>d.tipo,yAccessor:d=>d.total,rotateX:true});
  const alcData=Array.from(d3.rollup(data,v=>v.length,d=>d.alcaldia_catalogo),([a,t])=>({a,t})).sort((a,b)=>b.t-a.t).slice(0,20);
  drawBar({svg:d3.select('#chart-alcaldia'),data:alcData,xAccessor:d=>d.a,yAccessor:d=>d.t,rotateX:true});
  const diasData=Array.from(d3.rollup(data,v=>v.length,d=>d.dia_semana_numero||0),([n,t])=>({n,t})).sort((a,b)=>a.n-b.n);
  drawBar({svg:d3.select('#chart-dia'),data:diasData,xAccessor:d=>d.n,yAccessor:d=>d.t,rotateX:false});
}

// ===== Mapa D3 =====
let cdmxGeoJSON = null;
async function renderMapaD3(data){
  let puntos=data.filter(d=>d.latitud&&d.longitud);
  const svg=d3.select('#map-d3'); 
  svg.selectAll('*').remove(); 
  if(!puntos.length) return;

  const width=svg.node().clientWidth||900;
  const height=svg.node().clientHeight||360;

  // cargar geojson si no está cargado
  if(!cdmxGeoJSON){
    cdmxGeoJSON = await d3.json("https://raw.githubusercontent.com/PhantomInsights/mexico-geojson/main/cdmx-alcaldias.json");
  }

  // proyección ajustada a la CDMX
  const projection = d3.geoMercator().fitSize([width, height], cdmxGeoJSON);
  const path = d3.geoPath().projection(projection);

  // dibujar mapa de alcaldías
  svg.append("g")
    .selectAll("path")
    .data(cdmxGeoJSON.features)
    .enter().append("path")
    .attr("d", path)
    .attr("fill", "#1e293b")
    .attr("stroke", "#475569")
    .attr("stroke-width", 1);

  // reducir puntos si son demasiados
  if(puntos.length>2000){ 
    const sampleRate=Math.ceil(puntos.length/2000); 
    puntos=puntos.filter((_,i)=>i%sampleRate===0); 
  }

  // dibujar incidentes
  svg.append("g")
    .selectAll("circle")
    .data(puntos)
    .enter()
    .append("circle")
    .attr("cx", d => projection([d.longitud, d.latitud])[0])
    .attr("cy", d => projection([d.longitud, d.latitud])[1])
    .attr("r", 3)
    .attr("fill", d => colorScale(d.tipo_incidente_c4))
    .attr("opacity", 0.7)
    .append("title")
    .text(d => `${d.tipo_incidente_c4}\n${d.alcaldia_catalogo}\n${d.fecha_creacion}`);
}

// ===== Mapa Leaflet =====
let leafletMap=null, markerGroup=null;
function renderMapaLeaflet(data){
  const puntos=data.filter(d=>d.latitud&&d.longitud);
  if(!leafletMap){
    leafletMap=L.map('map-leaflet').setView([19.4326,-99.1332],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OSM'}).addTo(leafletMap);
  }
  if(markerGroup){ markerGroup.clearLayers(); } else { markerGroup=L.markerClusterGroup(); leafletMap.addLayer(markerGroup); }
  puntos.forEach(d=>{ const m=L.marker([d.latitud,d.longitud]).bindPopup(`<b>${d.tipo_incidente_c4}</b><br/>${d.alcaldia_catalogo}<br/>${d.fecha_creacion}`); markerGroup.addLayer(m); });
  if(puntos.length){ try{ leafletMap.fitBounds(markerGroup.getBounds().pad(0.2)); }catch(e){console.warn(e);} }
}

// ===== Render =====
function renderAll(data){ renderTabla(data); renderCharts(data); renderMapaD3(data); renderMapaLeaflet(data); }

// ===== Eventos =====
document.getElementById('inputCSV').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{ try{ const raw=parseCSV(ev.target.result); const data=normalizeRaw(raw); renderAll(data); } catch(err){ console.error(err); } };
  reader.readAsText(file);
});

document.getElementById('sampleBtn').addEventListener('click',()=>{
  const sampleCSV=`fecha_creacion,tipo_incidente_c4,alcaldia_catalogo,latitud,longitud,dia_semana_numero
01/01/2023,Choque,Tlalpan,19.28719,-99.14887,7
02/01/2023,Robo,Coyoacán,19.3467,-99.1617,1
03/01/2023,Incendio,Álvaro Obregón,19.3602,-99.2031,2`;
  try{ const raw=parseCSV(sampleCSV); const data=normalizeRaw(raw); renderAll(data); } catch(err){ console.error(err); }
});
</script>
</body>
</html>
